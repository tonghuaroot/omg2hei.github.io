<!DOCTYPE html><html lang="en"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> Smogcloud - AWS external network asset discovery platform · TonghuaRoot's BloG. - Cyber security enthusiast, not Hacker.</title><meta name="description" content="Smogcloud - AWS external network asset discovery platform - TonghuaRoot"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="https://tonghuaroot.com/atom.xml" title="TonghuaRoot's BloG. - Cyber security enthusiast, not Hacker."></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="/about" target="_self" class="nav-list-link">ABOUT</a></li><li class="nav-list-item"><a href="https://twitter.com/tonghuaroot" target="_blank" class="nav-list-link">TWITTE</a></li><li class="nav-list-item"><a href="https://github.com/tonghuaroot" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/friends" target="_self" class="nav-list-link">FRS</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">Smogcloud - AWS external network asset discovery platform</h1><div class="post-info">Nov 16, 2020</div><div class="post-content"><h2 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h2><p>对于一家大量采用AWS的甲方企业来说，如何实时的发现暴露在外网的AWS资产对其进行企业安全建设来说则至关重要。这些暴露在外面的AWS资产就是潜在的攻击面，我们可以这些资产进行更高优先级的监控，确保当出现安全问题时可以第一时间进行事件响应。而来我们也可以对这些暴露再外的资产进行高优先级的风险评估，尽量避免其出现已知的安全问题。当然，随着业务的发展，暴露在外的资产信息也是动态变化的，如何实时的收集到这些变化的动态资产信息，进行高优先级的风险评估是一个值得思考的问题。<br>我们没有办法保护我们看不到的资产，在这篇文章中，我主要记录一下我对Smogcloud这款开源项目的一些研究，以及如何配合Smogcloud和其他工具耦合起来实现高效且稳定的AWS公网资产监控平台。</p>
<h2 id="0x01-Smogcloud-简介"><a href="#0x01-Smogcloud-简介" class="headerlink" title="0x01 Smogcloud 简介"></a>0x01 Smogcloud 简介</h2><p>如 Smogcloud 的 README 页面所述，其主要解决的问题就是发现暴露在外网的AWS资产，全量、实时、稳定的AWS资产监控平台是我们实施下一步安全手段的第一步。<br>Smogcloud 主要解决的问题如下：</p>
<ol>
<li>针对多个AWS账号进行外网资产发现</li>
<li>针对这些资产进行检查是否存在错误配置或者相关安全问题</li>
<li>识别长时间未使用的资产</li>
<li>识别未被监控到的资产</li>
<li>Shadow IT</li>
</ol>
<h2 id="0x02-当前环境"><a href="#0x02-当前环境" class="headerlink" title="0x02 当前环境"></a>0x02 当前环境</h2><ul>
<li>Amazon Linux 2</li>
<li>Golang 1.15.5</li>
</ul>
<h2 id="0x03-Smogcloud-的安装和配置"><a href="#0x03-Smogcloud-的安装和配置" class="headerlink" title="0x03 Smogcloud 的安装和配置"></a>0x03 Smogcloud 的安装和配置</h2><p>由于 Smogcloud  是基于 Golang 开发的，在使用 Smogcloud 之前我们要先安装Golang的开发环境。看了下代码写的还是比较简洁的，直接拿来用用，后面需要的话直接上手改代码简单扩展一些也是ok的。<br>一、Golang 的安装和配置步骤如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">wget https://golang.org/dl/go1.15.5.linux-amd64.tar.gz</span><br><span class="line">vim ~/.bash_profile</span><br><span class="line">export PATH=$PATH:/usr/local/go/bin</span><br><span class="line">source ~/.bash_profile</span><br><span class="line">go version</span><br></pre></td></tr></table></figure></p>
<p>安装成功之后会展示出如下信息：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@ip-10-188-188-188 ec2-user]# go  version</span><br><span class="line">go version go1.15.5 linux/amd64</span><br></pre></td></tr></table></figure></p>
<p>二、安装 Smogcloud<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">go get -u github.com/BishopFox/smogcloud</span><br><span class="line">smogcloud</span><br></pre></td></tr></table></figure></p>
<p>出现这个报错的话，说明我们已经安装成功了，接下来我们需要配置账号ID和访问凭证，来进行资产收集了。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@ip-10-188-188-188 ec2-user]# smogcloud</span><br><span class="line"></span><br><span class="line"> Cannot list functions for region us-east-1</span><br><span class="line">NoCredentialProviders: no valid providers in chain. Deprecated.</span><br><span class="line">	For verbose messaging see aws.Config.CredentialsChainVerboseErrors</span><br></pre></td></tr></table></figure></p>
<p>三、配置 Smogcloud<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">export AWS_ACCOUNT_ID=&apos;&apos;            # Describe account</span><br><span class="line">export AWS_ACCESS_KEY_ID=&apos;&apos;         # Access key for aws account</span><br><span class="line">export AWS_SECRET_ACCESS_KEY=&apos;&apos;     # Secret key for aws account</span><br></pre></td></tr></table></figure></p>
<p>配置完成之后再次运行smogcloud执行，对这些暴露在外网的资产进行收集。<br>收集完成之后相关结果保存在results文件夹下。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@ip-10-188-188-188 results]# tree</span><br><span class="line">.</span><br><span class="line">|-- apigateway</span><br><span class="line">|   `-- 123456789012.us-west-2.json</span><br><span class="line">|-- ec2</span><br><span class="line">|   `-- 123456789012.us-west-2.json</span><br><span class="line">|-- iot</span><br><span class="line">|   |-- 123456789012.us-west-2.json</span><br><span class="line">|   `-- 123456789012.us-east-1.json</span><br><span class="line">`-- s3</span><br><span class="line">    `-- 123456789012.global.json</span><br><span class="line"></span><br><span class="line">4 directories, 5 files</span><br></pre></td></tr></table></figure></p>
<h2 id="0x04-Smogcloud-的二次开发"><a href="#0x04-Smogcloud-的二次开发" class="headerlink" title="0x04 Smogcloud 的二次开发"></a>0x04 Smogcloud 的二次开发</h2><p>Smogcloud 本质上是调研AWS Golang SDK获取资产信息对于符合条件的资产进行收集。严格来讲，其仅仅是一个用于收集信息的脚本，我们可以顺着这个思路进行二次开发，将收集到的信息进行入库及分析展示。<br>这里举一个小例子，通过收集包含工网IP的EC2实例，结合其附加的安全组以及端口扫描情况可以梳理出来对外暴露的端口。对于不合规的端口进行告警，对于必须暴露的端口如Web应用进行其他手段的安全测试。对于其他的服务，如S3一类的，也是同样的思路。<br>再就是如何配合AWS Config服务，利用Config服务收集资产信息，配合rule进行合规性检查。</p>
<h2 id="0x05-参考链接"><a href="#0x05-参考链接" class="headerlink" title="0x05 参考链接"></a>0x05 参考链接</h2><p>[1] Smogcloud：<a href="https://github.com/BishopFox/smogcloud" target="_blank" rel="noopener">https://github.com/BishopFox/smogcloud</a><br>[2] Golang Installation, Setup, GOPATH, and Go Workspace <a href="https://www.callicoder.com/golang-installation-setup-gopath-workspace/" target="_blank" rel="noopener">https://www.callicoder.com/golang-installation-setup-gopath-workspace/</a></p>
</div></article></div></main><footer><div class="paginator"><a href="/2020/11/25/This-is-a-test-page-for-testing-Github-Action/" class="prev">PREV</a><a href="/2020/09/14/write-a-simple-HTTPS-server-use-Go/" class="next">NEXT</a></div><div class="copyright"><p>© 2008 - 2022 <a href="https://tonghuaroot.com">TonghuaRoot</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>