<!DOCTYPE html><html lang="en"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 聊一聊AssumeRole和Trust Relationship · TonghuaRoot's BloG. - Cyber security enthusiast, not Hacker.</title><meta name="description" content="聊一聊AssumeRole和Trust Relationship - TonghuaRoot"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="https://tonghuaroot.com/atom.xml" title="TonghuaRoot's BloG. - Cyber security enthusiast, not Hacker."></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="/about" target="_self" class="nav-list-link">ABOUT</a></li><li class="nav-list-item"><a href="https://twitter.com/tonghuaroot" target="_blank" class="nav-list-link">TWITTE</a></li><li class="nav-list-item"><a href="https://github.com/tonghuaroot" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/friends" target="_self" class="nav-list-link">FRS</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">聊一聊AssumeRole和Trust Relationship</h1><div class="post-info">Nov 21, 2019</div><div class="post-content"><h2 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h2><p>AWS在IAM服务提供了一个Role的功能，Role的话就是可以扩大自己的权限，比如说一个user可以临时assume一个role，那这个user就具备这个role的权限了。或者跨账号访问的时候也可以用这个role。再比如说我做SSO的时候，也是用role实现的。</p>
<p>那和role相关的最小action都有哪些呢？这一节我们就来聊一聊这块。</p>
<h2 id="0x01-IAM-Role-权限的组成部分"><a href="#0x01-IAM-Role-权限的组成部分" class="headerlink" title="0x01 IAM Role 权限的组成部分"></a>0x01 IAM Role 权限的组成部分</h2><p>我这里创建两个role（一个role A，一个role B），role A是为了让EC2实例附加，role B是为了让role A assume。</p>
<p>Role B的Policy具有管理员权限（当然我们这节也不用关系它），重点看看role B的信任关系，和role A的Policy。</p>
<p>IAM Role 的权限通常由两部分组成，一个是Policy，一个是Trust Relationship（信任关系）。Policy就是我这个role能干多大的事。信任关系就是说，谁能assume这个role，这里的“谁”，可能是指user、role等等。其实我现在jio着这个信任关系，倒是跟S3 Bucket Policy还是有几分相像的。</p>
<p>那就先看看这个role还有信任关系啥的吧：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">[root@ip-10-0-0-64 tmp]# aws iam get-role --role-name assumerole_role_target</span><br><span class="line">&#123;</span><br><span class="line">    &quot;Role&quot;: &#123;</span><br><span class="line">        &quot;Description&quot;: &quot;Allows EC2 instances to call AWS services on your behalf.&quot;,</span><br><span class="line">        &quot;AssumeRolePolicyDocument&quot;: &#123;</span><br><span class="line">            &quot;Version&quot;: &quot;2012-10-17&quot;,</span><br><span class="line">            &quot;Statement&quot;: [</span><br><span class="line">                &#123;</span><br><span class="line">                    &quot;Action&quot;: &quot;sts:AssumeRole&quot;,</span><br><span class="line">                    &quot;Effect&quot;: &quot;Allow&quot;,</span><br><span class="line">                    &quot;Principal&quot;: &#123;</span><br><span class="line">                        &quot;AWS&quot;: &quot;arn:aws-cn:iam::123456789012:role/assume_role_ec2&quot;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;MaxSessionDuration&quot;: 3600,</span><br><span class="line">        &quot;RoleId&quot;: &quot;AROAUKT6WCRVQNHNPAHIN&quot;,</span><br><span class="line">        &quot;CreateDate&quot;: &quot;2019-11-21T03:46:08Z&quot;,</span><br><span class="line">        &quot;Tags&quot;: [</span><br><span class="line">            &#123;</span><br><span class="line">                &quot;Value&quot;: &quot;test&quot;,</span><br><span class="line">                &quot;Key&quot;: &quot;Name&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        ],</span><br><span class="line">        &quot;RoleName&quot;: &quot;assumerole_role_target&quot;,</span><br><span class="line">        &quot;Path&quot;: &quot;/&quot;,</span><br><span class="line">        &quot;Arn&quot;: &quot;arn:aws-cn:iam::123456789012:role/assumerole_role_target&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">[root@ip-10-0-0-64 tmp]#</span><br></pre></td></tr></table></figure></p>
<p>再来看看role A的Policy：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@ip-10-0-0-64 tmp]# aws iam list-role-policies --role-name assume_role_ec2</span><br><span class="line">&#123;</span><br><span class="line">    &quot;PolicyNames&quot;: []</span><br><span class="line">&#125;</span><br><span class="line">[root@ip-10-0-0-64 tmp]#</span><br></pre></td></tr></table></figure></p>
<p>为空时因为我们没有内联策略，然后我现在给他附加了一个托管策略（admin_test），不过策略的内容是空的。</p>
<p><img src="C23DC59AE3E44289B02B5388D53A17D6" alt="image"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@ip-10-0-0-64 tmp]# aws iam get-policy --policy-arn arn:aws-cn:iam::123456789012:policy/admin_test</span><br><span class="line">&#123;</span><br><span class="line">    &quot;Policy&quot;: &#123;</span><br><span class="line">        &quot;PolicyName&quot;: &quot;admin_test&quot;,</span><br><span class="line">        &quot;PermissionsBoundaryUsageCount&quot;: 0,</span><br><span class="line">        &quot;CreateDate&quot;: &quot;2019-11-21T04:06:32Z&quot;,</span><br><span class="line">        &quot;AttachmentCount&quot;: 1,</span><br><span class="line">        &quot;IsAttachable&quot;: true,</span><br><span class="line">        &quot;PolicyId&quot;: &quot;ANPAUKT6WCRV5UNNV3DZA&quot;,</span><br><span class="line">        &quot;DefaultVersionId&quot;: &quot;v3&quot;,</span><br><span class="line">        &quot;Path&quot;: &quot;/&quot;,</span><br><span class="line">        &quot;Arn&quot;: &quot;arn:aws-cn:iam::123456789012:policy/admin_test&quot;,</span><br><span class="line">        &quot;UpdateDate&quot;: &quot;2019-11-21T04:35:13Z&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">[root@ip-10-0-0-64 tmp]#</span><br></pre></td></tr></table></figure>
<p>可以看到我现在这个role现在附加的Policy只有个ec2:DescribeInstances权限，对IAM相关的权限肯定没啥影响。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@ip-10-0-0-64 tmp]# aws iam get-policy-version --policy-arn arn:aws-cn:iam::123456789012:policy/admin_test  --version-id v4</span><br><span class="line">&#123;</span><br><span class="line">    &quot;PolicyVersion&quot;: &#123;</span><br><span class="line">        &quot;CreateDate&quot;: &quot;2019-11-21T08:45:11Z&quot;,</span><br><span class="line">        &quot;VersionId&quot;: &quot;v4&quot;,</span><br><span class="line">        &quot;Document&quot;: &#123;</span><br><span class="line">            &quot;Version&quot;: &quot;2012-10-17&quot;,</span><br><span class="line">            &quot;Statement&quot;: [</span><br><span class="line">                &#123;</span><br><span class="line">                    &quot;Action&quot;: &quot;ec2:DescribeInstances&quot;,</span><br><span class="line">                    &quot;Resource&quot;: &quot;*&quot;,</span><br><span class="line">                    &quot;Effect&quot;: &quot;Allow&quot;,</span><br><span class="line">                    &quot;Sid&quot;: &quot;VisualEditor0&quot;</span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;IsDefaultVersion&quot;: true</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">[root@ip-10-0-0-64 tmp]#</span><br></pre></td></tr></table></figure></p>
<h2 id="0x02-测试看看"><a href="#0x02-测试看看" class="headerlink" title="0x02 测试看看"></a>0x02 测试看看</h2><p>然后我现在做一个assume操作试试：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@ip-10-0-0-64 tmp]# aws sts assume-role --role-arn arn:aws-cn:iam::123456789012:role/assumerole_role_target --role-session-name xxx</span><br><span class="line">&#123;</span><br><span class="line">    &quot;AssumedRoleUser&quot;: &#123;</span><br><span class="line">        &quot;AssumedRoleId&quot;: &quot;AROAUKT6WCRVQNHNPAHIN:xxx&quot;,</span><br><span class="line">        &quot;Arn&quot;: &quot;arn:aws-cn:sts::123456789012:assumed-role/assumerole_role_target/xxx&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;Credentials&quot;: &#123;</span><br><span class="line">        &quot;SecretAccessKey&quot;: &quot;xx&quot;,</span><br><span class="line">        &quot;SessionToken&quot;: &quot;xx&quot;,</span><br><span class="line">        &quot;Expiration&quot;: &quot;2019-11-21T09:49:55Z&quot;,</span><br><span class="line">        &quot;AccessKeyId&quot;: &quot;xx&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">[root@ip-10-0-0-64 tmp]# date</span><br><span class="line">Thu Nov 21 08:50:35 UTC 2019</span><br><span class="line">[root@ip-10-0-0-64 tmp]#</span><br></pre></td></tr></table></figure></p>
<p>可以看到已经成了。</p>
<p>那我再来修改一下role B的信任关系，修改成当前账号的root arn试试。</p>
<p><img src="C8FA85D9759946C0B7A19E705254ECCB" alt="image"></p>
<p>然后在执行assume role操作，可以看到这个操作被拒绝了：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@ip-10-0-0-64 tmp]# aws sts assume-role --role-arn arn:aws-cn:iam::123456789012:role/assumerole_role_target --role-session-name xxx</span><br><span class="line"></span><br><span class="line">An error occurred (AccessDenied) when calling the AssumeRole operation: User: arn:aws-cn:sts::123456789012:assumed-role/assume_role_ec2/i-111ecda157b494afe is not authorized to perform: sts:AssumeRole on resource: arn:aws-cn:iam::123456789012:role/assumerole_role_target</span><br><span class="line">[root@ip-10-0-0-64 tmp]#</span><br></pre></td></tr></table></figure></p>
<p>那这是因为啥呢，起初我刚看到这个现象的时候一脸懵逼啊，心想我root账号都有权限了，凭啥role就没权限搞呢？</p>
<p>后来想想对标一下S3 Bucket Policy这个事就明了了，我只是把权限给root了，但是作为root账号我还要把权限委派下去啊，我需要给role A一个sts:AssumeRole的权限。</p>
<p><img src="9615AC89FD9C4A09B115202C8CD12751" alt="image"></p>
<p>再来试试：</p>
<p><img src="1F90A49B947A45AEB7CCC47AA19770E3" alt="image"></p>
<p>可以看到已经成功了哈。</p>
<h2 id="0x03-跨账号能这么玩吗？"><a href="#0x03-跨账号能这么玩吗？" class="headerlink" title="0x03 跨账号能这么玩吗？"></a>0x03 跨账号能这么玩吗？</h2><p><img src="8A360C98FDAA4B7C9E02F5E4A490BFF1" alt="image"></p>
<p>嗯，试了一下，跨账号这么晚也没啥毛病。</p>
<p>当然比较常见的使用方法，除了使用cli，在控制台中也可以这么操作：</p>
<p><img src="A93793ABD19D4B16AF13AC377B4C7A22" alt="image"></p>
<h2 id="0x04-总结"><a href="#0x04-总结" class="headerlink" title="0x04 总结"></a>0x04 总结</h2><ul>
<li>同一账号下，role B的信任关系中有role A的ARN就够了</li>
<li>跨账号的场景下，role C（另一个账号的role，信任关系中要包含role A的ARN，role A也要有assume role的权限才能玩）</li>
</ul>
<h2 id="0x05-参考链接"><a href="#0x05-参考链接" class="headerlink" title="0x05 参考链接"></a>0x05 参考链接</h2><ul>
<li><a href="https://docs.aws.amazon.com/cli/latest/reference/iam/list-role-policies.html" target="_blank" rel="noopener">list-role-policies</a></li>
<li><a href="https://docs.aws.amazon.com/cli/latest/reference/iam/get-role.html" target="_blank" rel="noopener">get-role</a></li>
<li><a href="https://docs.aws.amazon.com/cli/latest/reference/iam/get-role-policy.html" target="_blank" rel="noopener">get-role-policy</a></li>
</ul>
</div></article></div></main><footer><div class="paginator"><a href="/2019/11/21/S3-Bucket-Policy-Only-One-User/" class="prev">PREV</a><a href="/2019/11/19/AWS-Lambda-Node-js-reverse-shell/" class="next">NEXT</a></div><div class="copyright"><p>© 2008 - 2022 <a href="https://tonghuaroot.com">TonghuaRoot</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>