<!DOCTYPE html><html lang="en"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> AWS S3 Multipart Upload · TonghuaRoot's BloG. - Cyber security enthusiast, not Hacker.</title><meta name="description" content="AWS S3 Multipart Upload - TonghuaRoot"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="https://tonghuaroot.com/atom.xml" title="TonghuaRoot's BloG. - Cyber security enthusiast, not Hacker."></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="/about" target="_self" class="nav-list-link">ABOUT</a></li><li class="nav-list-item"><a href="https://twitter.com/tonghuaroot" target="_blank" class="nav-list-link">TWITTE</a></li><li class="nav-list-item"><a href="https://github.com/omg2hei" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/friends" target="_self" class="nav-list-link">FRS</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">AWS S3 Multipart Upload</h1><div class="post-info">Nov 8, 2019</div><div class="post-content"><h2 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h2><p>记录一下S3分段上传相关的内容，主要涉及到原理以及使用方法，还有一些坑什么的。</p>
<h2 id="0x01-如何生成大小合适的垃圾文件？"><a href="#0x01-如何生成大小合适的垃圾文件？" class="headerlink" title="0x01 如何生成大小合适的垃圾文件？"></a>0x01 如何生成大小合适的垃圾文件？</h2><p>为了完全覆盖到上传时可能涉及到的边界条件，我们需要构造大小合适的垃圾文件。在这里我们可以使用如下命令生成指定大小的文件：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dd if=/dev/zero of=tonghua.5G bs=1M count=5120</span><br></pre></td></tr></table></figure></p>
<h2 id="0x02-单文件上传"><a href="#0x02-单文件上传" class="headerlink" title="0x02 单文件上传"></a>0x02 单文件上传</h2><p>单文件上传区别于分段上传，就是我一个文件就是一个文件，也不做任何切割，直接把文件整个上传到S3就完事了。单文件上传本质上调用了<a href="https://docs.aws.amazon.com/AmazonS3/latest/API/API_PutObject.html" target="_blank" rel="noopener">PutObject</a>这个API，他有一些限制，比如说它最多支持上传5G的文件，大于5G的我们就只能使用分段上传了。<br>但是这里也不是说我5G以下就只使用这个也是不对的，根据自己的业务场景，选择合适的分段大小可以极大的提到上传效率，也会避免文件过大中途由于网络等问题导致上传失败什么的。<br>需要留意的是，S3单文件上传最多支持上传5G的文件，大于就不行了。这点可以在官方文档中找到：<a href="https://docs.aws.amazon.com/AmazonS3/latest/dev/UploadingObjects.html" target="_blank" rel="noopener">Uploading Objects</a></p>
<p>这里我做个演示：</p>
<ol>
<li>先生成一个5G大小的垃圾文件：<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@ip-10-0-0-64 test]# dd if=/dev/zero of=tonghua.5G bs=1M count=5120</span><br><span class="line">5120+0 records in</span><br><span class="line">5120+0 records out</span><br><span class="line">5368709120 bytes (5.4 GB) copied, 81.8725 s, 65.6 MB/s</span><br><span class="line">[root@ip-10-0-0-64 test]# file tonghua.5G</span><br><span class="line">tonghua.5G: data</span><br><span class="line">[root@ip-10-0-0-64 test]# ls -alth tonghua.5G</span><br><span class="line">-rw-r--r-- 1 root root 5.0G Nov  5 06:09 tonghua.5G</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p><img src="F55C10721AC04AE4857465234166B6FF" alt="image"></p>
<ol start="2">
<li>然后将其上传至指定的S3 Bucket中<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@ip-10-0-0-64 test]# aws s3api put-object --bucket aaabbb --key test/tonghua.5G --body tonghua.5G</span><br><span class="line">&#123;</span><br><span class="line">    &quot;ETag&quot;: &quot;\&quot;ec4bcc8776ea04479b786e063a9ace45\&quot;&quot;</span><br><span class="line">&#125;</span><br><span class="line">[root@ip-10-0-0-64 test]# md5sum tonghua.5G</span><br><span class="line">ec4bcc8776ea04479b786e063a9ace45  tonghua.5G</span><br><span class="line">[root@ip-10-0-0-64 test]#</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p><img src="10DBDBDC42C14FD59DB7517A5A279D0A" alt="image"></p>
<p>可以看到目前已经上传成功了。（md5值也是一样的，说明这个文件是完整的）</p>
<ol start="3">
<li>那我如果多加1个字节的内容会发生啥事呢？<br>可以看到直接报错了，文件过大导致上传失败。<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@ip-10-0-0-64 test]# echo 1 &gt;&gt; tonghua.5G</span><br><span class="line">[root@ip-10-0-0-64 test]# ls -alth tonghua.5G</span><br><span class="line">-rw-r--r-- 1 root root 5.1G Nov  5 06:59 tonghua.5G</span><br><span class="line">[root@ip-10-0-0-64 test]# aws s3api put-object --bucket aaabbb --key test/tonghua.5G --body tonghua.5G</span><br><span class="line"></span><br><span class="line">An error occurred (EntityTooLarge) when calling the PutObject operation: Your proposed upload exceeds the maximum allowed size</span><br><span class="line">[root@ip-10-0-0-64 test]#</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p><img src="A0F325E7BC7C4FF88015B57C0558C81F" alt="image"></p>
<p>好了，这块不是重点，知道单文件最大传5个G就完事了，接下来我们看看分段上传。</p>
<h2 id="0x03-S3分段上传原理"><a href="#0x03-S3分段上传原理" class="headerlink" title="0x03 S3分段上传原理"></a>0x03 S3分段上传原理</h2><p>分段上传，文档里有提到，最小5M，最大5T。<br>分段上传拢共分为三步：</p>
<ol>
<li>初始化</li>
<li>分段上传</li>
<li>组装</li>
</ol>
<p>这里我拿1G的文件做个测试：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">[root@ip-10-0-0-64 test]# dd if=/dev/zero of=tonghua.1G bs=1M count=1024</span><br><span class="line">1024+0 records in</span><br><span class="line">1024+0 records out</span><br><span class="line">1073741824 bytes (1.1 GB) copied, 14.9912 s, 71.6 MB/s</span><br><span class="line">[root@ip-10-0-0-64 test]# file tonghua.1G</span><br><span class="line">tonghua.1G: data</span><br><span class="line">[root@ip-10-0-0-64 test]# ls -alth tonghua.1G</span><br><span class="line">-rw-r--r-- 1 root root 1.0G Nov  5 08:10 tonghua.1G</span><br><span class="line">[root@ip-10-0-0-64 test]# aws s3 cp tonghua.1G s3://aaabbb/test/tonghua.1G</span><br><span class="line">upload: ./tonghua.1G to s3://aaabbb/test/tonghua.1G</span><br><span class="line">[root@ip-10-0-0-64 test]# aws s3api get-object --bucket aaabbb --key test/tonghua.1G 233</span><br><span class="line">&#123;</span><br><span class="line">    &quot;AcceptRanges&quot;: &quot;bytes&quot;,</span><br><span class="line">    &quot;ContentType&quot;: &quot;binary/octet-stream&quot;,</span><br><span class="line">    &quot;LastModified&quot;: &quot;Tue, 05 Nov 2019 08:11:27 GMT&quot;,</span><br><span class="line">    &quot;ContentLength&quot;: 1073741824,</span><br><span class="line">    &quot;ETag&quot;: &quot;\&quot;c789e490a90359de2bd3b09d7e957cfd-128\&quot;&quot;,</span><br><span class="line">    &quot;Metadata&quot;: &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line">[root@ip-10-0-0-64 test]# aws s3api head-object --bucket aaabbb --key test/tonghua.1G</span><br><span class="line">&#123;</span><br><span class="line">    &quot;AcceptRanges&quot;: &quot;bytes&quot;,</span><br><span class="line">    &quot;ContentType&quot;: &quot;binary/octet-stream&quot;,</span><br><span class="line">    &quot;LastModified&quot;: &quot;Tue, 05 Nov 2019 08:11:27 GMT&quot;,</span><br><span class="line">    &quot;ContentLength&quot;: 1073741824,</span><br><span class="line">    &quot;ETag&quot;: &quot;\&quot;c789e490a90359de2bd3b09d7e957cfd-128\&quot;&quot;,</span><br><span class="line">    &quot;Metadata&quot;: &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line">[root@ip-10-0-0-64 test]# md5sum tonghua.1G</span><br><span class="line">cd573cfaace07e7949bc0c46028904ff  tonghua.1G</span><br></pre></td></tr></table></figure></p>
<p>可以看到文件上传成功，通过ETag的内容我们可知其被分成了128段，然后组装在一起了，也就是8M一段，这也是默认的分段大小。</p>
<p>我拿了一个16M/9M的两个文件做了个测试，会被分成两段，至此可以得出结论，cli默认文件大于8M之后就会采用分段上传了。（下面的文档上也写了这一点）</p>
<p>这个也是可以在CLI配置文件中做修改的，具体可以参考这个链接<a href="https://docs.aws.amazon.com/cli/latest/topic/s3-config.html" target="_blank" rel="noopener">AWS CLI S3 Configuration</a>。</p>
<ul>
<li>multipart_chunksize 参数控制一个文件片段为多大</li>
<li>multipart_threshold 参数控制大于多大的文件会采用分段上传操作</li>
</ul>
<p>需要提及的是，这个只支持aws s3命令，而不适用与aws s3api命令。</p>
<h2 id="0x04-实践S3分段上传"><a href="#0x04-实践S3分段上传" class="headerlink" title="0x04 实践S3分段上传"></a>0x04 实践S3分段上传</h2><p>这里我用s3api演示一下手动分段上传。</p>
<ol>
<li>先把一个1G的文件拆开(200M一份，拢共6份)：<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@ip-10-0-0-64 test]# split -b 200M tonghua.1G</span><br><span class="line">[root@ip-10-0-0-64 test]# ls -alth</span><br><span class="line">total 14G</span><br><span class="line">-rw-r--r--  1 root root  24M Nov  7 06:20 xaf</span><br><span class="line">drwxr-xr-x  2 root root  182 Nov  7 06:20 .</span><br><span class="line">-rw-r--r--  1 root root 200M Nov  7 06:20 xae</span><br><span class="line">-rw-r--r--  1 root root 200M Nov  7 06:20 xad</span><br><span class="line">-rw-r--r--  1 root root 200M Nov  7 06:20 xac</span><br><span class="line">-rw-r--r--  1 root root 200M Nov  7 06:20 xab</span><br><span class="line">-rw-r--r--  1 root root 200M Nov  7 06:20 xaa</span><br><span class="line">dr-xr-x--- 13 root root 4.0K Nov  7 00:00 ..</span><br><span class="line">-rw-r--r--  1 root root 9.0M Nov  5 08:56 tonghua.9M</span><br><span class="line">-rw-r--r--  1 root root  16M Nov  5 08:34 tonghua.16M</span><br><span class="line">-rw-r--r--  1 root root 1.0G Nov  5 08:28 233</span><br><span class="line">-rw-r--r--  1 root root 1.0G Nov  5 08:10 tonghua.1G</span><br><span class="line">-rw-r--r--  1 root root 5.1G Nov  5 06:59 tonghua.5G</span><br><span class="line">-rw-r--r--  1 root root 5.0G Nov  5 06:04 tmp.5G</span><br><span class="line">-rw-r--r--  1 root root   89 Oct 30 08:39 1.py</span><br><span class="line">[root@ip-10-0-0-64 test]#</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p><img src="2D610E1EB72A44D3B2EBC0A3A4C09603" alt="image"></p>
<ol start="2">
<li>再做个初始化上传的操作：<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@ip-10-0-0-64 test]# aws s3api create-multipart-upload --bucket aaabbb --key tonghua.1G.MTU</span><br><span class="line">&#123;</span><br><span class="line">    &quot;Bucket&quot;: &quot;aaabbb&quot;,</span><br><span class="line">    &quot;UploadId&quot;: &quot;z6NUjopY8OMv0Qd4Uomi9U4L_hs8ceLesZA4hJZzCm2mRwa0FW4U6ndTsnSnJ6gcVWAPYY_xtV6wIwjeb_AYPRqjGvtF6dtv3NOez3boX9.d4cWudryKsnpfieanIl5.&quot;,</span><br><span class="line">    &quot;Key&quot;: &quot;tonghua.1G.MTU&quot;</span><br><span class="line">&#125;</span><br><span class="line">[root@ip-10-0-0-64 test]#</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p><img src="A1A045BE164E4FF1AB7625BE4FBDA97F" alt="image"></p>
<ol start="3">
<li><p>把刚刚切下来的6段分别上传上去：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[root@ip-10-0-0-64 test]# aws s3api upload-part --bucket aaabbb --key tonghua.1G.MTU --part-number 1 --body              xaa --upload-id z6NUjopY8OMv0Qd4Uomi9U4L_hs8ceLesZA4hJZzCm2mRwa0FW4U6ndTsnSnJ6gcVWAPYY_xtV6wIwjeb_AYPRqjGv             tF6dtv3NOez3boX9.d4cWudryKsnpfieanIl5.</span><br><span class="line">&#123;</span><br><span class="line">    &quot;ETag&quot;: &quot;\&quot;3566de3a97906edb98d004d6b947ae9b\&quot;&quot;</span><br><span class="line">&#125;</span><br><span class="line">[root@ip-10-0-0-64 test]# aws s3api upload-part --bucket aaabbb --key tonghua.1G.MTU --part-number 2 --body              xab --upload-id z6NUjopY8OMv0Qd4Uomi9U4L_hs8ceLesZA4hJZzCm2mRwa0FW4U6ndTsnSnJ6gcVWAPYY_xtV6wIwjeb_AYPRqjGv             tF6dtv3NOez3boX9.d4cWudryKsnpfieanIl5.</span><br><span class="line">&#123;</span><br><span class="line">    &quot;ETag&quot;: &quot;\&quot;3566de3a97906edb98d004d6b947ae9b\&quot;&quot;</span><br><span class="line">&#125;</span><br><span class="line">[root@ip-10-0-0-64 test]# aws s3api upload-part --bucket aaabbb --key tonghua.1G.MTU --part-number 3 --body              xac --upload-id z6NUjopY8OMv0Qd4Uomi9U4L_hs8ceLesZA4hJZzCm2mRwa0FW4U6ndTsnSnJ6gcVWAPYY_xtV6wIwjeb_AYPRqjGv             tF6dtv3NOez3boX9.d4cWudryKsnpfieanIl5.</span><br><span class="line">&#123;</span><br><span class="line">    &quot;ETag&quot;: &quot;\&quot;3566de3a97906edb98d004d6b947ae9b\&quot;&quot;</span><br><span class="line">&#125;</span><br><span class="line">[root@ip-10-0-0-64 test]# aws s3api upload-part --bucket aaabbb --key tonghua.1G.MTU --part-number 4 --body              xad --upload-id z6NUjopY8OMv0Qd4Uomi9U4L_hs8ceLesZA4hJZzCm2mRwa0FW4U6ndTsnSnJ6gcVWAPYY_xtV6wIwjeb_AYPRqjGv             tF6dtv3NOez3boX9.d4cWudryKsnpfieanIl5.</span><br><span class="line">&#123;</span><br><span class="line">    &quot;ETag&quot;: &quot;\&quot;3566de3a97906edb98d004d6b947ae9b\&quot;&quot;</span><br><span class="line">&#125;</span><br><span class="line">[root@ip-10-0-0-64 test]# aws s3api upload-part --bucket aaabbb --key tonghua.1G.MTU --part-number 5 --body              xae --upload-id z6NUjopY8OMv0Qd4Uomi9U4L_hs8ceLesZA4hJZzCm2mRwa0FW4U6ndTsnSnJ6gcVWAPYY_xtV6wIwjeb_AYPRqjGv             tF6dtv3NOez3boX9.d4cWudryKsnpfieanIl5.</span><br><span class="line">&#123;</span><br><span class="line">    &quot;ETag&quot;: &quot;\&quot;3566de3a97906edb98d004d6b947ae9b\&quot;&quot;</span><br><span class="line">&#125;</span><br><span class="line">[root@ip-10-0-0-64 test]# aws s3api upload-part --bucket aaabbb --key tonghua.1G.MTU --part-number 6 --body              xaf --upload-id z6NUjopY8OMv0Qd4Uomi9U4L_hs8ceLesZA4hJZzCm2mRwa0FW4U6ndTsnSnJ6gcVWAPYY_xtV6wIwjeb_AYPRqjGv             tF6dtv3NOez3boX9.d4cWudryKsnpfieanIl5.</span><br><span class="line">&#123;</span><br><span class="line">    &quot;ETag&quot;: &quot;\&quot;77377273b0a4b61febdbf7bbf52b9db9\&quot;&quot;</span><br><span class="line">&#125;</span><br><span class="line">[root@ip-10-0-0-64 test]#</span><br></pre></td></tr></table></figure>
</li>
<li><p>上传完成之后先确认一下是否全都传上去了：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">[root@ip-10-0-0-64 test]# aws s3api list-parts --bucket aaabbb --key tonghua.1G.MTU --upload-id z6NUjopY8OMv0Qd4Uomi9U4L_hs8ceLesZA4hJZzCm2mRwa0FW4U6ndTsnSnJ6gcVWAPYY_xtV6wIwjeb_AYPRqjGvtF6dtv3NOez3boX9.d4cWudryKsnpfieanIl5.</span><br><span class="line">&#123;</span><br><span class="line">    &quot;Owner&quot;: &#123;</span><br><span class="line">        &quot;DisplayName&quot;: &quot;tonghua&quot;,</span><br><span class="line">        &quot;ID&quot;: &quot;75ca81520a6a8f31111e9ac0a8efec8c3b89076f67d161cdbc7382cb0aadc377&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;Initiator&quot;: &#123;</span><br><span class="line">        &quot;DisplayName&quot;: &quot;xxxxx&quot;,</span><br><span class="line">        &quot;ID&quot;: &quot;arn:aws-cn:iam::297123123419:user/xxxxx&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;Parts&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;LastModified&quot;: &quot;2019-11-08T09:05:05.000Z&quot;,</span><br><span class="line">            &quot;PartNumber&quot;: 1,</span><br><span class="line">            &quot;ETag&quot;: &quot;\&quot;3566de3a97906edb98d004d6b947ae9b\&quot;&quot;,</span><br><span class="line">            &quot;Size&quot;: 209715200</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;LastModified&quot;: &quot;2019-11-08T09:05:35.000Z&quot;,</span><br><span class="line">            &quot;PartNumber&quot;: 2,</span><br><span class="line">            &quot;ETag&quot;: &quot;\&quot;3566de3a97906edb98d004d6b947ae9b\&quot;&quot;,</span><br><span class="line">            &quot;Size&quot;: 209715200</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;LastModified&quot;: &quot;2019-11-08T09:05:51.000Z&quot;,</span><br><span class="line">            &quot;PartNumber&quot;: 3,</span><br><span class="line">            &quot;ETag&quot;: &quot;\&quot;3566de3a97906edb98d004d6b947ae9b\&quot;&quot;,</span><br><span class="line">            &quot;Size&quot;: 209715200</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;LastModified&quot;: &quot;2019-11-08T09:06:07.000Z&quot;,</span><br><span class="line">            &quot;PartNumber&quot;: 4,</span><br><span class="line">            &quot;ETag&quot;: &quot;\&quot;3566de3a97906edb98d004d6b947ae9b\&quot;&quot;,</span><br><span class="line">            &quot;Size&quot;: 209715200</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;LastModified&quot;: &quot;2019-11-08T09:06:21.000Z&quot;,</span><br><span class="line">            &quot;PartNumber&quot;: 5,</span><br><span class="line">            &quot;ETag&quot;: &quot;\&quot;3566de3a97906edb98d004d6b947ae9b\&quot;&quot;,</span><br><span class="line">            &quot;Size&quot;: 209715200</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;LastModified&quot;: &quot;2019-11-08T09:06:35.000Z&quot;,</span><br><span class="line">            &quot;PartNumber&quot;: 6,</span><br><span class="line">            &quot;ETag&quot;: &quot;\&quot;77377273b0a4b61febdbf7bbf52b9db9\&quot;&quot;,</span><br><span class="line">            &quot;Size&quot;: 25165824</span><br><span class="line">        &#125;</span><br><span class="line">    ],</span><br><span class="line">    &quot;StorageClass&quot;: &quot;STANDARD&quot;</span><br><span class="line">&#125;</span><br><span class="line">[root@ip-10-0-0-64 test]#</span><br></pre></td></tr></table></figure>
</li>
<li><p>确认无误后，将这些文件段组装在一起：<br>先创建1个文件fileparts.json</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;Parts&quot;: [&#123;</span><br><span class="line">        &quot;ETag&quot;: &quot;3566de3a97906edb98d004d6b947ae9b&quot;,</span><br><span class="line">        &quot;PartNumber&quot;:1</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;ETag&quot;: &quot;3566de3a97906edb98d004d6b947ae9b&quot;,</span><br><span class="line">        &quot;PartNumber&quot;:2</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;ETag&quot;: &quot;3566de3a97906edb98d004d6b947ae9b&quot;,</span><br><span class="line">        &quot;PartNumber&quot;:3</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;ETag&quot;: &quot;3566de3a97906edb98d004d6b947ae9b&quot;,</span><br><span class="line">        &quot;PartNumber&quot;:4</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;ETag&quot;: &quot;3566de3a97906edb98d004d6b947ae9b&quot;,</span><br><span class="line">        &quot;PartNumber&quot;:5</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;ETag&quot;: &quot;77377273b0a4b61febdbf7bbf52b9db9&quot;,</span><br><span class="line">        &quot;PartNumber&quot;:6</span><br><span class="line">    &#125;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>然后执行如下命令将其组装：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@ip-10-0-0-64 test]# aws s3api complete-multipart-upload --multipart-upload file://fileparts.json --bucket aaabbb --key tonghua.1G.MTU --upload-id z6NUjopY8OMv0Qd4Uomi9U4L_hs8ceLesZA4hJZzCm2mRwa0FW4U6ndTsnSnJ6gcVWAPYY_xtV6wIwjeb_AYPRqjGvtF6dtv3NOez3boX9.d4cWudryKsnpfieanIl5.</span><br><span class="line">&#123;</span><br><span class="line">    &quot;ETag&quot;: &quot;\&quot;9088a3364a043bb55249cda2b0ff5fe1-6\&quot;&quot;,</span><br><span class="line">    &quot;Bucket&quot;: &quot;aaabbb&quot;,</span><br><span class="line">    &quot;Location&quot;: &quot;https://aaabbb.s3.cn-north-1.amazonaws.com.cn/tonghua.1G.MTU&quot;,</span><br><span class="line">    &quot;Key&quot;: &quot;tonghua.1G.MTU&quot;</span><br><span class="line">&#125;</span><br><span class="line">[root@ip-10-0-0-64 test]#</span><br></pre></td></tr></table></figure></p>
<p>那现在呢，分段上传操作其实就已经完成了。<br>可以再做一个文件完整性校验，两种方法，一种是将文件下载回来做与大文件做比对，一种是用S3 etag完整性校验做一个比对。</p>
<p>先来看看方法一：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@ip-10-0-0-64 test]# aws s3 cp s3://aaabbb/tonghua.1G.MTU tonghua.1G.MTU</span><br><span class="line">download: s3://aaabbb/tonghua.1G.MTU to ./tonghua.1G.MTU</span><br><span class="line">[root@ip-10-0-0-64 test]# md5sum tonghua.1G.MTU</span><br><span class="line">cd573cfaace07e7949bc0c46028904ff  tonghua.1G.MTU</span><br><span class="line">[root@ip-10-0-0-64 test]# md5sum tonghua.1G</span><br><span class="line">cd573cfaace07e7949bc0c46028904ff  tonghua.1G</span><br><span class="line">[root@ip-10-0-0-64 test]#</span><br></pre></td></tr></table></figure></p>
<p>嗯，没啥毛病。</p>
<p>方法二：<br>算法就是每一个分段的md5串在一起在求一个md5，完事后面-N就完事了。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@ip-10-0-0-64 test]# echo &quot;3566de3a97906edb98d004d6b947ae9b3566de3a97906edb98d004d6b947ae9b3566de3a97906edb98d004d6b947ae9b3566de3a97906edb98d004d6b947ae9b3566de3a97906edb98d004d6b947ae9b77377273b0a4b61febdbf7bbf52b9db9&quot; | xxd -r -p | md5sum</span><br><span class="line">9088a3364a043bb55249cda2b0ff5fe1  -</span><br><span class="line">[root@ip-10-0-0-64 test]# aws s3api head-object --bucket aaabbb --key tonghua.1G.MTU</span><br><span class="line">&#123;</span><br><span class="line">    &quot;AcceptRanges&quot;: &quot;bytes&quot;,</span><br><span class="line">    &quot;ContentType&quot;: &quot;binary/octet-stream&quot;,</span><br><span class="line">    &quot;LastModified&quot;: &quot;Thu, 07 Nov 2019 06:27:23 GMT&quot;,</span><br><span class="line">    &quot;ContentLength&quot;: 1073741824,</span><br><span class="line">    &quot;ETag&quot;: &quot;\&quot;9088a3364a043bb55249cda2b0ff5fe1-6\&quot;&quot;,</span><br><span class="line">    &quot;Metadata&quot;: &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line">[root@ip-10-0-0-64 test]#</span><br></pre></td></tr></table></figure></p>
<p>至此，手动S3分段上传完成，也校验了文件完整性，感觉问题不大了。</p>
<h2 id="0x05-关于S3多文件上传的一些坑点"><a href="#0x05-关于S3多文件上传的一些坑点" class="headerlink" title="0x05 关于S3多文件上传的一些坑点"></a>0x05 关于S3多文件上传的一些坑点</h2><ol>
<li>我执行cp命令，自动分段上传，中间由于网络或者我手动停止了，我中间上传一半可能就断了，导致这部分残留的object片段不能看到完事还收钱。<br>可以用这个命令看到有没有残留的文件片段：<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@ip-10-0-0-64 test]# aws s3api list-multipart-uploads --bucket aaabbb                                              &#123;</span><br><span class="line">    &quot;Uploads&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;Initiator&quot;: &#123;</span><br><span class="line">                &quot;DisplayName&quot;: &quot;11111&quot;,</span><br><span class="line">                &quot;ID&quot;: &quot;arn:aws-cn:iam::2971111111111111:user/11111&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;Initiated&quot;: &quot;2019-11-08T13:24:45.000Z&quot;,</span><br><span class="line">            &quot;UploadId&quot;: &quot;fdsBIrZ4amSsimTB4uzZosKp0toutli9kZr8Twir0YGi.QqVvWTWwsCpjnxazEdHMjAlbSMqsEgcOqku2MO9FTXKsr_guaall14gYFZz5aVze05WSdbscDR07NlCZ09p&quot;,</span><br><span class="line">            &quot;StorageClass&quot;: &quot;STANDARD&quot;,</span><br><span class="line">            &quot;Key&quot;: &quot;test_multipart&quot;,</span><br><span class="line">            &quot;Owner&quot;: &#123;</span><br><span class="line">                &quot;DisplayName&quot;: &quot;tonghua&quot;,</span><br><span class="line">                &quot;ID&quot;: &quot;75ca81520a6a8f399c2e9ac0a8efec8c3b89076f67d161cdbc7382cb0aadc377&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">[root@ip-10-0-0-64 test]#</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>删除这些残留的文件，通常有两种方法：<br>方法一：使用cli命令手动删除<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@ip-10-0-0-64 test]# aws s3api abort-multipart-upload --bucket aaabbb --key &quot;test_multipart&quot; --upload-id &quot;fdsBIrZ4amSsimTB4uzZosKp0toutli9kZr8Twir0YGi.QqVvWTWwsCpjnxazEdHMjAlbSMqsEgcOqku2MO9FTXKsr_guaall14gYFZz5aVze05WSdbscDR07NlCZ09p&quot;</span><br><span class="line">[root@ip-10-0-0-64 test]#</span><br></pre></td></tr></table></figure></p>
<p>方法二：CCR生命周期规则走一波<br><img src="BA50E9E412D24C73BAFE2DCB0BB81672" alt="image"><br>保存之后就可以利用CCR定期删除残留的文件片段了。</p>
<h2 id="0x06-后记"><a href="#0x06-后记" class="headerlink" title="0x06 后记"></a>0x06 后记</h2><p>大概就是这样，先到这里了，溜了溜了。</p>
<h2 id="0x07-参考链接"><a href="#0x07-参考链接" class="headerlink" title="0x07 参考链接"></a>0x07 参考链接</h2><ul>
<li><a href="https://aws.amazon.com/premiumsupport/knowledge-center/s3-multipart-upload-cli/?nc1=h_ls" target="_blank" rel="noopener">How do I use the AWS CLI to perform a multipart upload of a file to Amazon S3?</a></li>
<li><a href="https://blog.csdn.net/beswkwangbo/article/details/46375795" target="_blank" rel="noopener">Linux 用dd生成指定大小的文件</a></li>
<li><a href="https://docs.aws.amazon.com/AmazonS3/latest/API/API_PutObject.html" target="_blank" rel="noopener">PutObject</a></li>
<li><a href="https://docs.aws.amazon.com/cli/latest/topic/s3-config.html" target="_blank" rel="noopener">AWS CLI S3 Configuration</a></li>
<li><a href="https://xbuba.com/questions/12186993" target="_blank" rel="noopener">为大于5GB的文件计算Amazon-S3 Etag的算法是什么？</a></li>
</ul>
</div></article></div></main><footer><div class="paginator"><a href="/2019/11/12/AWS-S3-Versioning/" class="prev">PREV</a><a href="/2019/11/01/AWS-ALB-Access-log-And-KMS/" class="next">NEXT</a></div><div class="copyright"><p>© 2008 - 2019 <a href="https://tonghuaroot.com">TonghuaRoot</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>