<!DOCTYPE html><html lang="en"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 聊一聊AWS S3的版本控制 · TonghuaRoot's BloG. - Cyber security enthusiast, not Hacker.</title><meta name="description" content="聊一聊AWS S3的版本控制 - TonghuaRoot"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="https://tonghuaroot.com/atom.xml" title="TonghuaRoot's BloG. - Cyber security enthusiast, not Hacker."></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="/about" target="_self" class="nav-list-link">ABOUT</a></li><li class="nav-list-item"><a href="https://twitter.com/tonghuaroot" target="_blank" class="nav-list-link">TWITTE</a></li><li class="nav-list-item"><a href="https://github.com/tonghuaroot" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/friends" target="_self" class="nav-list-link">FRS</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">聊一聊AWS S3的版本控制</h1><div class="post-info">Nov 13, 2019</div><div class="post-content"><h2 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h2><p>为了避免文件误删除、误修改，这里有一个版本控制的功能。</p>
<h2 id="0x01-AWS-S3-版本控制"><a href="#0x01-AWS-S3-版本控制" class="headerlink" title="0x01 AWS S3 版本控制"></a>0x01 AWS S3 版本控制</h2><p>一个比较有意思的点，S3版本控制功能一旦启用之后，是不能禁用的，只能暂停。</p>
<p>来通过CLI观察一下版本控制的三种状态：</p>
<ol>
<li>未开启版本控制</li>
<li>开启版本控制</li>
<li>暂停版本控制</li>
</ol>
<p><img src="D06AC1AA16134565A529DA0D1094E751" alt="image"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[ec2-user@ip-10-0-0-64 ~]$ aws s3api get-bucket-versioning --bucket tonghua-test01</span><br><span class="line">[ec2-user@ip-10-0-0-64 ~]$ aws s3api get-bucket-versioning --bucket tonghua-test01</span><br><span class="line">&#123;</span><br><span class="line">    &quot;Status&quot;: &quot;Enabled&quot;</span><br><span class="line">&#125;</span><br><span class="line">[ec2-user@ip-10-0-0-64 ~]$ aws s3api get-bucket-versioning --bucket tonghua-test01</span><br><span class="line">&#123;</span><br><span class="line">    &quot;Status&quot;: &quot;Suspended&quot;</span><br><span class="line">&#125;</span><br><span class="line">[ec2-user@ip-10-0-0-64 ~]$</span><br></pre></td></tr></table></figure>
<p>那有一个问题，比如说，我一个S3 Bucket开启了版本控制功能，然后上传文件，同时也产生了多个版本，然后我把它版本控制功能给暂停了，那么之前的object的多个版本仍然会存在，是不会被删掉的，只是再上传上去的文件没有多个版本了而已。</p>
<p>再有一个，就是我暂停版本控制之后，再往上传对象的时候，会产生一个对象为null的新版本。</p>
<p><img src="E42AB2E5662A44B684F35E7D242EEDE3" alt="image"></p>
<p>做个实验看一看：</p>
<ol>
<li>暂停版本控制的时候上传1个对象，查看对象的状态</li>
<li>启用版本控制的时候上传1个对象，在上传一个同名对象给覆盖掉，查看对象状态</li>
<li>暂停版本控制，上传一个对象，观察对象的状态</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[ec2-user@ip-10-0-0-64 ~]$ aws s3api get-bucket-versioning --bucket tonghua-test01</span><br><span class="line">&#123;</span><br><span class="line">    &quot;Status&quot;: &quot;Suspended&quot;</span><br><span class="line">&#125;</span><br><span class="line">[ec2-user@ip-10-0-0-64 ~]$ aws s3 ls s3://tonghua-test01</span><br><span class="line">[ec2-user@ip-10-0-0-64 ~]$ aws s3 ls s3://tonghua-test01</span><br><span class="line">2019-11-13 04:13:04          5 test01_no_version.txt</span><br><span class="line">[ec2-user@ip-10-0-0-64 ~]$ aws s3api get-bucket-versioning --bucket tonghua-test01</span><br><span class="line">&#123;</span><br><span class="line">    &quot;Status&quot;: &quot;Enabled&quot;</span><br><span class="line">&#125;</span><br><span class="line">[ec2-user@ip-10-0-0-64 ~]$ aws s3 ls s3://tonghua-test01</span><br><span class="line">2019-11-13 04:13:04          5 test01_no_version.txt</span><br><span class="line">2019-11-13 04:14:21          5 test02_version.txt</span><br><span class="line">[ec2-user@ip-10-0-0-64 ~]$ aws s3 ls s3://tonghua-test01</span><br><span class="line">2019-11-13 04:13:04          5 test01_no_version.txt</span><br><span class="line">2019-11-13 04:15:02         12 test02_version.txt</span><br><span class="line">[ec2-user@ip-10-0-0-64 ~]$ aws s3api delete-object --bucket tonghua-test01 --key test02_version.txt</span><br><span class="line">&#123;</span><br><span class="line">    &quot;VersionId&quot;: &quot;fJt7vWnW8oWhQoHIQ0KitAuIeJZfr2Xb&quot;,</span><br><span class="line">    &quot;DeleteMarker&quot;: true</span><br><span class="line">&#125;</span><br><span class="line">[ec2-user@ip-10-0-0-64 ~]$</span><br></pre></td></tr></table></figure>
<p><img src="77D60C75D0DB438F85AF7B0DBDE0456F" alt="image"></p>
<p>版本ID为null的是我在开启版本控制之前上传的对象。</p>
<p>这里就有一个比较有意思的问题了，就是我该如何操作才能删除这个version id为null的对象呢？<br>用控制台可以直接删，在CLI中使用–version-id null完事删除失败(错了，试了下，CLI中使用–version-id null也能删，没啥意思。）。</p>
<p>那我做deletemarker的时候，是再创建一份对象，然后打上deletemarker的标签吗？<br>看起来不是，deletemarker没啥大小。直接就0KB了，不过要是做list object的话，那还是要都遍历一遍，而这些都遍历一遍，那还是挺耗时的。完事虽然这些不会显示出来，但是会频繁响应空的XML，可能会有timeout的风险什么的。解决这个问题的方法也会比较简单粗暴了，用V2版本的api就成<a href="https://docs.aws.amazon.com/cli/latest/reference/s3api/list-objects-v2.html" target="_blank" rel="noopener">list-objects-v2</a></p>
<p>那我一个对象的多个版本是不是就可以做多个deletemarker了呢？<br>如果我在delete-object时指定一个–version-id，那我是不会做deletemarker的，只会把对应版本的对象给删掉。<br>不过话又说回来，如果我不指定–version-id，只用delete-object的话，那就会有多个deletemarker的标签了<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[ec2-user@ip-10-0-0-64 ~]$ aws s3api delete-object --bucket tonghua-test01 --key test04_no_version.txt</span><br><span class="line">&#123;</span><br><span class="line">    &quot;VersionId&quot;: &quot;vYIFZjYvlioPSExISCzo6aUswP2BsbO1&quot;,</span><br><span class="line">    &quot;DeleteMarker&quot;: true</span><br><span class="line">&#125;</span><br><span class="line">[ec2-user@ip-10-0-0-64 ~]$ aws s3api delete-object --bucket tonghua-test01 --key test04_no_version.txt</span><br><span class="line">&#123;</span><br><span class="line">    &quot;VersionId&quot;: &quot;e5LeaiviCJMS.lYn8zi4vkmaeBzCY3xC&quot;,</span><br><span class="line">    &quot;DeleteMarker&quot;: true</span><br><span class="line">&#125;</span><br><span class="line">[ec2-user@ip-10-0-0-64 ~]$</span><br></pre></td></tr></table></figure></p>
<p><img src="C624DF16818348D5980BD0C0A6C86BE1" alt="image"></p>
<h2 id="0x02-后记"><a href="#0x02-后记" class="headerlink" title="0x02 后记"></a>0x02 后记</h2><p>没啥说的，就是开版本控制，deletemarker之后，如果没注意，可能会看到桶中的总容量，与我当前版本的容量不一致的情况，这是因为老版本也会占用存储空间。<br>然后分段上传产生的为组装的一起的片段也是占用空间的。</p>
<h2 id="0x03-参考链接"><a href="#0x03-参考链接" class="headerlink" title="0x03 参考链接"></a>0x03 参考链接</h2><ul>
<li><a href="https://docs.aws.amazon.com/cli/latest/reference/s3api/list-objects-v2.html" target="_blank" rel="noopener">list-objects-v2</a></li>
</ul>
</div></article></div></main><footer><div class="paginator"><a href="/2019/11/15/AWS-EBS-UUID-EC2-Change-Instance-Type/" class="prev">PREV</a><a href="/2019/11/08/AWS-S3-Multipart-Upload/" class="next">NEXT</a></div><div class="copyright"><p>© 2008 - 2020 <a href="https://tonghuaroot.com">TonghuaRoot</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>